<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spaceship Multiplayer</title>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    font-family: Arial, sans-serif;
  }

  #background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 0;
  }

  #game {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
  }

  #joinPanel {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.9);
    padding: 30px;
    border-radius: 15px;
    color: white;
    z-index: 100;
    min-width: 300px;
  }

  #joinPanel h3 {
    margin-bottom: 15px;
    color: #00ffff;
    text-align: center;
  }

  #joinPanel input {
    display: block;
    margin-bottom: 12px;
    padding: 10px;
    width: 100%;
    border-radius: 5px;
    border: none;
    font-size: 14px;
  }

  #joinPanel button {
    width: 100%;
    padding: 12px;
    background: #00ffff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    color: black;
  }

  #joinPanel button:hover {
    background: #00dddd;
  }

  #errorMsg {
    color: #ff4444;
    font-size: 12px;
    margin-top: 10px;
    text-align: center;
  }

  .ship {
    position: absolute;
    transform-origin: center;
  }

  .ship-small { width: 40px; height: 40px; }
  .ship-medium { width: 50px; height: 50px; }
  .ship-large { width: 60px; height: 60px; }

  .player-name {
    position: absolute;
    top: 45px;
    left: -40px;
    width: 120px;
    text-align: center;
    font-size: 11px;
    font-weight: bold;
    color: white;
    text-shadow: 0 0 4px black, 0 0 8px black;
    pointer-events: none;
    white-space: nowrap;
  }

  .kill-counter {
    position: absolute;
    top: 60px;
    left: -40px;
    width: 120px;
    text-align: center;
    font-size: 10px;
    color: #00ff00;
    text-shadow: 0 0 4px black;
    pointer-events: none;
  }

  .bullet {
    position: absolute;
    width: 4px;
    height: 10px;
    background: currentColor;
    border-radius: 2px;
    box-shadow: 0 0 5px currentColor;
    pointer-events: none;
  }

  #hud {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(0,0,0,0.8);
    padding: 15px;
    border-radius: 10px;
    color: white;
    font-size: 14px;
    z-index: 100;
    min-width: 200px;
  }

  #hud h4 {
    color: #00ffff;
    margin-bottom: 10px;
  }

  #connectionStatus {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(0,0,0,0.8);
    padding: 10px 15px;
    border-radius: 5px;
    color: #00ff00;
    font-size: 12px;
    z-index: 100;
  }

  .disconnected {
    color: #ff4444 !important;
  }
</style>
</head>

<body>

<video id="background" autoplay muted loop playsinline>
  <source src="universe_loop.mp4" type="video/mp4">
</video>

<div id="game">
  <div id="joinPanel">
    <h3>ðŸš€ Join Game</h3>
    <input id="playerName" type="text" placeholder="Your name" maxlength="20">
    <input id="playerColor" type="color" value="#00ffff">
    <button id="joinButton">Join Game</button>
    <div id="errorMsg"></div>
    <p style="font-size: 11px; margin-top: 15px; color: #888; text-align: center;">
      W=thrust â€¢ A/D=rotate â€¢ SPACE=shoot
    </p>
  </div>

  <div id="connectionStatus">Connecting...</div>

  <div id="hud" style="display: none;">
    <h4>Your Stats</h4>
    <div>Kills: <span id="killCount">0</span></div>
    <div>Health: <span id="healthCount">6</span>/6</div>
    <div>Ship: <span id="shipType">Small</span></div>
    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
      <div style="font-size: 12px; color: #888;">Players: <span id="playerCount">0</span></div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // CHANGE THIS TO YOUR GLITCH URL!
  const SERVER_URL = window.location.origin;
  const socket = io(SERVER_URL);

  const game = document.getElementById('game');
  const joinPanel = document.getElementById('joinPanel');
  const hud = document.getElementById('hud');
  const errorMsg = document.getElementById('errorMsg');
  const connectionStatus = document.getElementById('connectionStatus');

  let CENTER_X, CENTER_Y;
  const BLOCK_RADIUS = 350;
  const ROTATION_SPEED = 2.5;

  let myPlayer = null;
  let myPlayerId = null;
  let playerName = '';
  let playerColor = '#00ffff';
  let myX = 0, myY = 0, myAngle = 0, mySpeed = 0;
  let myHealth = 6, myKills = 0, myShipSize = 'small';

  const otherPlayers = new Map();
  const bullets = new Map();
  let lastShot = 0;
  const SHOT_COOLDOWN = 400;
  const keys = {};

  function updateCenter() {
    CENTER_X = window.innerWidth / 2;
    CENTER_Y = window.innerHeight / 2;
  }

  window.addEventListener('resize', updateCenter);
  updateCenter();

  // Socket events
  socket.on('connect', () => {
    connectionStatus.textContent = 'Connected';
    connectionStatus.classList.remove('disconnected');
  });

  socket.on('disconnect', () => {
    connectionStatus.textContent = 'Disconnected';
    connectionStatus.classList.add('disconnected');
  });

  socket.on('joinSuccess', (data) => {
    myPlayerId = data.playerId;
    joinPanel.style.display = 'none';
    hud.style.display = 'block';
    
    // Spawn my player
    spawnMyPlayer();
    
    // Add other players
    data.players.forEach(p => {
      if (p.id !== myPlayerId) {
        addOtherPlayer(p);
      }
    });
    
    updatePlayerCount();
  });

  socket.on('joinError', (msg) => {
    errorMsg.textContent = msg;
  });

  socket.on('playerJoined', (player) => {
    addOtherPlayer(player);
    updatePlayerCount();
  });

  socket.on('playerLeft', (playerId) => {
    const player = otherPlayers.get(playerId);
    if (player && player.element) {
      player.element.remove();
    }
    otherPlayers.delete(playerId);
    updatePlayerCount();
  });

  socket.on('playerMoved', (data) => {
    const player = otherPlayers.get(data.id);
    if (!player) return;
    
    player.x = data.x;
    player.y = data.y;
    player.angle = data.angle;
    player.speed = data.speed;
  });

  socket.on('bulletFired', (bullet) => {
    if (bullet.owner === myPlayerId) return; // Don't show our own bullets twice
    
    const bulletEl = document.createElement('div');
    bulletEl.className = 'bullet';
    bulletEl.style.color = bullet.color;
    game.appendChild(bulletEl);
    
    bullets.set(bullet.id, {
      ...bullet,
      element: bulletEl
    });
  });

  socket.on('playerDamaged', (data) => {
    if (data.victimId === myPlayerId) {
      myHealth = data.health;
      document.getElementById('healthCount').textContent = myHealth;
      
      // Flash
      if (myPlayer) {
        myPlayer.style.filter = 'brightness(3) saturate(0)';
        setTimeout(() => {
          if (myPlayer) myPlayer.style.filter = '';
        }, 200);
      }
    } else {
      const player = otherPlayers.get(data.victimId);
      if (player && player.element) {
        player.element.style.filter = 'brightness(3) saturate(0)';
        setTimeout(() => {
          if (player.element) player.element.style.filter = '';
        }, 200);
      }
    }
  });

  socket.on('playerDied', (data) => {
    if (data.victimId === myPlayerId) {
      die();
    } else if (data.killerId === myPlayerId) {
      myKills = data.killerKills;
      myShipSize = data.killerShipSize;
      document.getElementById('killCount').textContent = myKills;
      document.getElementById('shipType').textContent = 
        myShipSize.charAt(0).toUpperCase() + myShipSize.slice(1);
      updateMyShipVisual();
    } else {
      // Update other player
      const victim = otherPlayers.get(data.victimId);
      if (victim) {
        victim.kills = 0;
        victim.shipSize = 'small';
      }
      
      const killer = otherPlayers.get(data.killerId);
      if (killer) {
        killer.kills = data.killerKills;
        killer.shipSize = data.killerShipSize;
      }
    }
  });

  socket.on('playerRespawned', (data) => {
    const player = otherPlayers.get(data.id);
    if (!player) return;
    
    player.x = data.x;
    player.y = data.y;
    player.angle = 0;
    player.speed = 0;
  });

  socket.on('kicked', (msg) => {
    alert(msg);
    window.location.reload();
  });

  socket.on('banned', (msg) => {
    alert(msg);
    window.location.reload();
  });

  // Keyboard
  document.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = true;
    if (e.code === 'Space' && myPlayer) { 
      shoot(); 
      e.preventDefault(); 
    }
    if (['w','a','d','arrowup','arrowleft','arrowright'].includes(e.key.toLowerCase())) {
      e.preventDefault();
    }
  });

  document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

  function getShipSVG(size) {
    if (size === 'small') {
      return `<svg viewBox="0 0 40 40"><g fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="20,4 28,30 20,24 12,30" />
        <circle cx="20" cy="16" r="2" fill="currentColor" /></g></svg>`;
    } else if (size === 'medium') {
      return `<svg viewBox="0 0 50 50"><g fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="25,4 32,18 42,22 32,26 25,40 18,26 8,22 18,18" />
        <circle cx="25" cy="20" r="3" fill="currentColor" />
        <line x1="22" y1="34" x2="22" y2="42" /><line x1="28" y1="34" x2="28" y2="42" /></g></svg>`;
    } else {
      return `<svg viewBox="0 0 70 70"><g fill="none" stroke="currentColor" stroke-width="2.5">
        <polygon points="35,5 45,20 60,28 45,32 35,55 25,32 10,28 25,20" />
        <polygon points="5,30 15,35 5,40" /><polygon points="65,30 55,35 65,40" />
        <circle cx="35" cy="24" r="4" fill="currentColor" />
        <line x1="30" y1="52" x2="30" y2="65" /><line x1="35" y1="52" x2="35" y2="65" />
        <line x1="40" y1="52" x2="40" y2="65" /></g></svg>`;
    }
  }

  function spawnMyPlayer() {
    myPlayer = document.createElement('div');
    myPlayer.className = 'ship ship-small';
    myPlayer.style.color = playerColor;

    const nameEl = document.createElement('div');
    nameEl.className = 'player-name';
    nameEl.textContent = playerName + ' (You)';

    const killsEl = document.createElement('div');
    killsEl.className = 'kill-counter';
    killsEl.textContent = 'Kills: 0';

    myPlayer.innerHTML = getShipSVG('small');
    myPlayer.appendChild(nameEl);
    myPlayer.appendChild(killsEl);

    myX = CENTER_X + BLOCK_RADIUS + 60;
    myY = CENTER_Y;

    game.appendChild(myPlayer);
  }

  function addOtherPlayer(player) {
    const el = document.createElement('div');
    el.className = `ship ship-${player.shipSize}`;
    el.style.color = player.color;

    const nameEl = document.createElement('div');
    nameEl.className = 'player-name';
    nameEl.textContent = player.name;

    const killsEl = document.createElement('div');
    killsEl.className = 'kill-counter';
    killsEl.textContent = `Kills: ${player.kills}`;

    el.innerHTML = getShipSVG(player.shipSize);
    el.appendChild(nameEl);
    el.appendChild(killsEl);

    game.appendChild(el);

    otherPlayers.set(player.id, {
      ...player,
      element: el
    });
  }

  function updateMyShipVisual() {
    if (!myPlayer) return;

    myPlayer.className = `ship ship-${myShipSize}`;
    const nameEl = myPlayer.querySelector('.player-name');
    const killsEl = myPlayer.querySelector('.kill-counter');
    myPlayer.innerHTML = getShipSVG(myShipSize);
    myPlayer.appendChild(nameEl);
    myPlayer.appendChild(killsEl);
    if (killsEl) killsEl.textContent = `Kills: ${myKills}`;
  }

  function shoot() {
    const now = Date.now();
    if (now - lastShot < SHOT_COOLDOWN) return;
    lastShot = now;

    const radians = myAngle * Math.PI / 180;
    const bulletX = myX + Math.sin(radians) * 25;
    const bulletY = myY - Math.cos(radians) * 25;
    const vx = Math.sin(radians) * 8;
    const vy = -Math.cos(radians) * 8;

    // Send to server
    socket.emit('shoot', { x: bulletX, y: bulletY, vx, vy });

    // Create local bullet
    const bulletEl = document.createElement('div');
    bulletEl.className = 'bullet';
    bulletEl.style.color = playerColor;
    game.appendChild(bulletEl);

    const bulletId = `${myPlayerId}_${now}`;
    bullets.set(bulletId, {
      id: bulletId,
      x: bulletX,
      y: bulletY,
      vx, vy,
      color: playerColor,
      owner: myPlayerId,
      element: bulletEl
    });
  }

  function updateBullets() {
    bullets.forEach((bullet, id) => {
      bullet.x += bullet.vx;
      bullet.y += bullet.vy;

      // Remove if off screen
      if (bullet.x < -20 || bullet.x > window.innerWidth + 20 ||
          bullet.y < -20 || bullet.y > window.innerHeight + 20) {
        bullet.element.remove();
        bullets.delete(id);
        return;
      }

      // Remove if hits center
      const dx = bullet.x - CENTER_X;
      const dy = bullet.y - CENTER_Y;
      if (Math.sqrt(dx*dx + dy*dy) < BLOCK_RADIUS) {
        bullet.element.remove();
        bullets.delete(id);
        return;
      }

      // Check collision with my player
      if (bullet.owner !== myPlayerId && myPlayer) {
        const dist = Math.sqrt((bullet.x - myX)**2 + (bullet.y - myY)**2);
        if (dist < 25) {
          socket.emit('playerHit', { victimId: myPlayerId, shooterId: bullet.owner });
          bullet.element.remove();
          bullets.delete(id);
          return;
        }
      }

      // Check collision with other players (only my bullets)
      if (bullet.owner === myPlayerId) {
        for (const [pid, player] of otherPlayers.entries()) {
          const dist = Math.sqrt((bullet.x - player.x)**2 + (bullet.y - player.y)**2);
          if (dist < 25) {
            socket.emit('playerHit', { victimId: pid, shooterId: myPlayerId });
            bullet.element.remove();
            bullets.delete(id);
            return;
          }
        }
      }

      bullet.element.style.transform = `translate(${bullet.x}px, ${bullet.y}px)`;
    });
  }

  function die() {
    if (myPlayer) {
      myPlayer.remove();
      myPlayer = null;
    }
    
    myHealth = 6;
    myKills = 0;
    myShipSize = 'small';

    setTimeout(() => respawn(), 3000);
  }

  function respawn() {
    spawnMyPlayer();
    
    myX = CENTER_X + BLOCK_RADIUS + 60;
    myY = CENTER_Y;
    myAngle = 0;
    mySpeed = 0;

    socket.emit('respawn', { x: myX, y: myY });

    document.getElementById('healthCount').textContent = myHealth;
    document.getElementById('killCount').textContent = myKills;
    document.getElementById('shipType').textContent = 'Small';
  }

  function updatePlayerCount() {
    document.getElementById('playerCount').textContent = otherPlayers.size + 1;
  }

  function joinGame() {
    const name = document.getElementById('playerName').value.trim();
    if (!name) {
      errorMsg.textContent = 'Please enter a name';
      return;
    }

    playerName = name;
    playerColor = document.getElementById('playerColor').value;

    socket.emit('join', { name, color: playerColor });
  }

  document.getElementById('joinButton').addEventListener('click', joinGame);
  document.getElementById('playerName').addEventListener('keypress', e => {
    if (e.key === 'Enter') joinGame();
  });

  function update() {
    if (myPlayer) {
      // Rotation
      if (keys['a'] || keys['arrowleft']) myAngle -= ROTATION_SPEED;
      if (keys['d'] || keys['arrowright']) myAngle += ROTATION_SPEED;

      // Thrust
      if (keys['w'] || keys['arrowup']) mySpeed = Math.min(mySpeed + 0.3, 5);
      else mySpeed *= 0.96;

      // Movement
      const radians = myAngle * Math.PI / 180;
      let nx = myX + Math.sin(radians) * mySpeed;
      let ny = myY - Math.cos(radians) * mySpeed;

      // Center collision
      const dx = nx - CENTER_X;
      const dy = ny - CENTER_Y;
      if (Math.sqrt(dx*dx + dy*dy) > BLOCK_RADIUS) {
        myX = nx;
        myY = ny;
      } else {
        mySpeed *= 0.3;
      }

      // Screen wrap
      if (myX < 0) myX = window.innerWidth;
      if (myX > window.innerWidth) myX = 0;
      if (myY < 0) myY = window.innerHeight;
      if (myY > window.innerHeight) myY = 0;

      myPlayer.style.transform = `translate(${myX}px, ${myY}px) rotate(${myAngle}deg)`;

      // Send to server (throttled)
      if (Math.random() < 0.1) {
        socket.emit('updatePlayer', {
          x: myX,
          y: myY,
          angle: myAngle,
          speed: mySpeed
        });
      }
    }

    // Update other players
    otherPlayers.forEach(player => {
      if (player.element) {
        player.element.style.transform = 
          `translate(${player.x}px, ${player.y}px) rotate(${player.angle}deg)`;
      }
    });

    updateBullets();
    requestAnimationFrame(update);
  }

  update();
</script>

</body>
</html>
