<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spaceship Game - Spectator</title>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    font-family: Arial, sans-serif;
    background: black;
  }

  #gameContainer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  #background {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    min-width: 100%;
    min-height: 100%;
    width: auto;
    height: auto;
    object-fit: cover;
    z-index: 0;
  }

  #game {
    position: absolute;
    top: 0;
    left: 0;
    width: 2560px;
    height: 1440px;
    transform-origin: top left;
    z-index: 1;
  }

  .ship {
    position: absolute;
    transform-origin: center;
  }

  .ship-small { width: 40px; height: 40px; }
  .ship-medium { width: 50px; height: 50px; }
  .ship-large { width: 60px; height: 60px; }

  .player-name {
    position: absolute;
    top: 45px;
    left: -40px;
    width: 120px;
    text-align: center;
    font-size: 11px;
    font-weight: bold;
    color: white;
    text-shadow: 0 0 4px black, 0 0 8px black;
    pointer-events: none;
    white-space: nowrap;
  }

  .kill-counter {
    position: absolute;
    top: 60px;
    left: -40px;
    width: 120px;
    text-align: center;
    font-size: 10px;
    color: #00ff00;
    text-shadow: 0 0 4px black;
    pointer-events: none;
  }

  .bullet {
    position: absolute;
    width: 4px;
    height: 10px;
    background: currentColor;
    border-radius: 2px;
    box-shadow: 0 0 5px currentColor;
    pointer-events: none;
  }

  .x-beam {
    position: absolute;
    width: 40px;
    height: 2000px;
    background: linear-gradient(90deg, 
      transparent 0%, 
      rgba(255,0,0,0.3) 30%,
      rgba(255,255,255,0.9) 50%,
      rgba(255,0,0,0.3) 70%,
      transparent 100%
    );
    box-shadow: 0 0 20px rgba(255,255,255,0.8), 0 0 40px rgba(255,0,0,0.6);
    pointer-events: none;
    transform-origin: center center;
  }
</style>
</head>

<body>

<div id="gameContainer">
  <video id="background" autoplay muted loop playsinline>
    <source src="universe_loop.mp4" type="video/mp4">
  </video>

  <div id="game"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const SERVER_URL = window.location.origin;
  const socket = io(SERVER_URL);

  const game = document.getElementById('game');

  const GAME_WIDTH = 2560;
  const GAME_HEIGHT = 1440;

  const players = new Map();
  const npcs = new Map();
  const bullets = new Map();
  const xBeams = new Map();

  function scaleGame() {
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    
    const scaleX = windowWidth / GAME_WIDTH;
    const scaleY = windowHeight / GAME_HEIGHT;
    const scale = Math.min(scaleX, scaleY);
    
    game.style.transform = `scale(${scale})`;
    
    const scaledWidth = GAME_WIDTH * scale;
    const scaledHeight = GAME_HEIGHT * scale;
    game.style.left = `${(windowWidth - scaledWidth) / 2 / scale}px`;
    game.style.top = `${(windowHeight - scaledHeight) / 2 / scale}px`;
  }

  window.addEventListener('resize', scaleGame);
  scaleGame();

  function getShipSVG(size) {
    if (size === 'small') {
      return `<svg viewBox="0 0 40 40"><g fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="20,4 28,30 20,24 12,30" />
        <circle cx="20" cy="16" r="2" fill="currentColor" /></g></svg>`;
    } else if (size === 'medium') {
      return `<svg viewBox="0 0 50 50"><g fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="25,4 32,18 42,22 32,26 25,40 18,26 8,22 18,18" />
        <circle cx="25" cy="20" r="3" fill="currentColor" />
        <line x1="22" y1="34" x2="22" y2="42" /><line x1="28" y1="34" x2="28" y2="42" /></g></svg>`;
    } else {
      return `<svg viewBox="0 0 70 70"><g fill="none" stroke="currentColor" stroke-width="2.5">
        <polygon points="35,5 45,20 60,28 45,32 35,55 25,32 10,28 25,20" />
        <polygon points="5,30 15,35 5,40" /><polygon points="65,30 55,35 65,40" />
        <circle cx="35" cy="24" r="4" fill="currentColor" />
        <line x1="30" y1="52" x2="30" y2="65" /><line x1="35" y1="52" x2="35" y2="65" />
        <line x1="40" y1="52" x2="40" y2="65" /></g></svg>`;
    }
  }

  // Connection status
  socket.on('connect', () => {
    console.log('Spectator connected to server');
  });

  socket.on('disconnect', () => {
    console.log('Spectator disconnected');
  });

  socket.on('joinSuccess', (data) => {
    console.log('Spectator joined successfully, loading players:', data.players.length);
    data.players.forEach(p => {
      // Don't add ourselves (the spectator)
      if (p.id !== data.playerId) {
        addPlayer(p);
      }
    });
  });

  socket.on('joinError', (msg) => {
    console.error('Spectator join error:', msg);
  });

  socket.on('playerJoined', (player) => {
    console.log('Player joined:', player.name);
    addPlayer(player);
  });

  socket.on('playerLeft', (playerId) => {
    const player = players.get(playerId);
    if (player && player.element) {
      player.element.remove();
    }
    players.delete(playerId);
  });

  socket.on('playerMoved', (data) => {
    const player = players.get(data.id);
    if (!player) return;
    
    player.x = data.x;
    player.y = data.y;
    player.angle = data.angle;
  });

  socket.on('bulletFired', (bullet) => {
    const bulletEl = document.createElement('div');
    bulletEl.className = 'bullet';
    bulletEl.style.color = bullet.color;
    game.appendChild(bulletEl);
    
    bullets.set(bullet.id, {
      ...bullet,
      element: bulletEl
    });
  });

  socket.on('playerDied', (data) => {
    // Remove victim's ship immediately
    const victim = players.get(data.victimId);
    if (victim) {
      if (victim.element) {
        victim.element.remove();
        victim.element = null;
      }
      victim.kills = 0;
      victim.shipSize = 'small';
    }
    
    // Update killer's ship
    const killer = players.get(data.killerId);
    if (killer) {
      killer.kills = data.killerKills;
      killer.shipSize = data.killerShipSize;
      if (killer.element) {
        killer.element.className = `ship ship-${killer.shipSize}`;
        const nameEl = killer.element.querySelector('.player-name');
        const killsEl = killer.element.querySelector('.kill-counter');
        killer.element.innerHTML = getShipSVG(killer.shipSize);
        if (nameEl) killer.element.appendChild(nameEl);
        if (killsEl) {
          killsEl.textContent = `Kills: ${killer.kills}`;
          killer.element.appendChild(killsEl);
        }
      }
    }
  });

  // Force remove ghost ships
  socket.on('forceRemoveShip', (data) => {
    const player = players.get(data.playerId);
    if (player && player.element) {
      player.element.remove();
      player.element = null;
    }
  });

  socket.on('playerRespawned', (data) => {
    const player = players.get(data.id);
    if (!player) return;
    
    if (!player.element) {
      const el = document.createElement('div');
      el.className = 'ship ship-small';
      el.style.color = player.color;

      const nameEl = document.createElement('div');
      nameEl.className = 'player-name';
      nameEl.textContent = player.name;

      const killsEl = document.createElement('div');
      killsEl.className = 'kill-counter';
      killsEl.textContent = 'Kills: 0';

      el.innerHTML = getShipSVG('small');
      el.appendChild(nameEl);
      el.appendChild(killsEl);

      game.appendChild(el);
      player.element = el;
    }
    
    player.x = data.x;
    player.y = data.y;
  });

  // NPC handlers
  socket.on('npcSpawned', (npc) => {
    const el = document.createElement('div');
    el.className = npc.type === 'boss' ? 'ship ship-large' : 'ship ship-small';
    el.style.color = npc.color;

    const nameEl = document.createElement('div');
    nameEl.className = 'player-name';
    nameEl.textContent = npc.name;

    const svg = npc.type === 'boss' ? getBossSVG() : getEnemySVG();
    el.innerHTML = svg;
    el.appendChild(nameEl);

    game.appendChild(el);
    npcs.set(npc.id, { ...npc, element: el });
  });

  socket.on('npcUpdate', (npcList) => {
    npcList.forEach(npcData => {
      const npc = npcs.get(npcData.id);
      if (npc) {
        npc.x = npcData.x;
        npc.y = npcData.y;
        npc.angle = npcData.angle;
      }
    });
  });

  socket.on('npcDied', (data) => {
    const npc = npcs.get(data.npcId);
    if (npc && npc.element) {
      npc.element.remove();
      npcs.delete(data.npcId);
    }
  });

  socket.on('npcRemoved', (data) => {
    const npc = npcs.get(data.npcId);
    if (npc && npc.element) {
      npc.element.remove();
      npcs.delete(data.npcId);
    }
  });

  // Attack patterns
  socket.on('clockBullet', (bullet) => {
    const bulletEl = document.createElement('div');
    bulletEl.className = 'bullet';
    bulletEl.style.color = '#ff0000';
    game.appendChild(bulletEl);
    
    bullets.set(bullet.id, {
      ...bullet,
      element: bulletEl
    });
  });

  socket.on('xBeamSpawned', (beam) => {
    const beamEl = document.createElement('div');
    beamEl.className = 'x-beam';
    beamEl.style.left = beam.x + 'px';
    beamEl.style.top = beam.y + 'px';
    beamEl.style.transform = `rotate(${beam.angle}deg)`;
    game.appendChild(beamEl);
    
    xBeams.set(beam.id, {
      ...beam,
      element: beamEl
    });
  });

  socket.on('xBeamUpdate', (data) => {
    const beam = xBeams.get(data.id);
    if (beam && beam.element) {
      beam.x = data.x;
      beam.y = data.y;
      beam.angle = data.angle;
      beam.element.style.left = beam.x + 'px';
      beam.element.style.top = beam.y + 'px';
      beam.element.style.transform = `rotate(${beam.angle}deg)`;
    }
  });

  socket.on('xBeamRemoved', (data) => {
    const beam = xBeams.get(data.id);
    if (beam && beam.element) {
      beam.element.remove();
      xBeams.delete(data.id);
    }
  });

  function getEnemySVG() {
    return `<svg viewBox="0 0 40 40"><g fill="none" stroke="currentColor" stroke-width="2">
      <polygon points="20,4 28,30 20,24 12,30" />
      <circle cx="20" cy="16" r="2" fill="currentColor" /></g></svg>`;
  }

  function getBossSVG() {
    return `<svg viewBox="0 0 70 70"><g fill="none" stroke="currentColor" stroke-width="2">
      <polygon points="35,4 44,15 60,23 46,27 39,46 35,62 31,46 24,27 10,23 26,15" />
      <polygon points="8,27 15,33 8,39" />
      <polygon points="62,27 55,33 62,39" />
      <polygon points="35,12 43,23 35,43 27,23" />
      <line x1="27" y1="17" x2="43" y2="33" />
      <line x1="43" y1="17" x2="27" y2="33" />
      <line x1="29" y1="48" x2="29" y2="68" />
      <line x1="35" y1="50" x2="35" y2="70" />
      <line x1="41" y1="48" x2="41" y2="68" /></g></svg>`;
  }

  function addPlayer(playerData) {
    const el = document.createElement('div');
    el.className = `ship ship-${playerData.shipSize}`;
    el.style.color = playerData.color;

    const nameEl = document.createElement('div');
    nameEl.className = 'player-name';
    nameEl.textContent = playerData.name;

    const killsEl = document.createElement('div');
    killsEl.className = 'kill-counter';
    killsEl.textContent = `Kills: ${playerData.kills}`;

    el.innerHTML = getShipSVG(playerData.shipSize);
    el.appendChild(nameEl);
    el.appendChild(killsEl);

    game.appendChild(el);

    players.set(playerData.id, {
      ...playerData,
      element: el
    });
  }

  function updateBullets() {
    bullets.forEach((bullet, id) => {
      bullet.x += bullet.vx;
      bullet.y += bullet.vy;

      if (bullet.x < -100 || bullet.x > GAME_WIDTH + 100 ||
          bullet.y < -100 || bullet.y > GAME_HEIGHT + 100) {
        bullet.element.remove();
        bullets.delete(id);
        return;
      }

      bullet.element.style.transform = `translate(${bullet.x}px, ${bullet.y}px)`;
    });
  }

  function update() {
    players.forEach(player => {
      if (player.element) {
        player.element.style.transform = 
          `translate(${player.x}px, ${player.y}px) rotate(${player.angle}deg)`;
      }
    });

    npcs.forEach(npc => {
      if (npc.element) {
        npc.element.style.transform = 
          `translate(${npc.x}px, ${npc.y}px) rotate(${npc.angle}deg)`;
      }
    });

    updateBullets();
    requestAnimationFrame(update);
  }

  // Join as invisible spectator
  const spectatorName = 'SPEC_' + Math.random().toString(36).substr(2, 9);
  console.log('Joining as spectator:', spectatorName);
  socket.emit('join', { name: spectatorName, color: '#000000' });

  update();
</script>

</body>
</html>
