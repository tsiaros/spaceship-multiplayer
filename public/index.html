<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spaceship Multiplayer</title>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    font-family: Arial, sans-serif;
    background: black;
  }

  #gameContainer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  #background {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    min-width: 100%;
    min-height: 100%;
    width: auto;
    height: auto;
    object-fit: cover;
    z-index: 0;
  }

  #game {
    position: absolute;
    top: 0;
    left: 0;
    width: 2560px;
    height: 1440px;
    transform-origin: top left;
    z-index: 1;
  }

  #joinPanel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.9);
    padding: 30px;
    border-radius: 15px;
    color: white;
    z-index: 100;
    min-width: 320px;
  }

  #joinPanel h3 {
    margin-bottom: 15px;
    color: #00ffff;
    text-align: center;
  }

  #joinPanel label {
    display: block;
    font-size: 12px;
    color: #888;
    margin-bottom: 5px;
    margin-top: 10px;
  }

  #joinPanel input[type="text"] {
    display: block;
    margin-bottom: 5px;
    padding: 10px;
    width: 100%;
    border-radius: 5px;
    border: none;
    font-size: 14px;
  }

  #joinPanel input[type="color"] {
    width: 100%;
    height: 40px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-bottom: 15px;
  }

  #joinPanel button {
    width: 100%;
    padding: 12px;
    background: #00ffff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    color: black;
    margin-bottom: 8px;
  }

  #joinPanel button:hover {
    background: #00dddd;
  }

  #adminBtn {
    background: #ff8800;
    font-size: 12px;
    padding: 8px;
  }

  #adminBtn:hover {
    background: #dd6600;
  }

  #errorMsg {
    color: #ff4444;
    font-size: 12px;
    margin-top: 10px;
    text-align: center;
  }

  .ship {
    position: absolute;
    transform-origin: center;
  }

  .ship-small { width: 40px; height: 40px; }
  .ship-medium { width: 50px; height: 50px; }
  .ship-large { width: 60px; height: 60px; }

  .player-name {
    position: absolute;
    top: 45px;
    left: -40px;
    width: 120px;
    text-align: center;
    font-size: 11px;
    font-weight: bold;
    color: white;
    text-shadow: 0 0 4px black, 0 0 8px black;
    pointer-events: none;
    white-space: nowrap;
  }

  .kill-counter {
    position: absolute;
    top: 60px;
    left: -40px;
    width: 120px;
    text-align: center;
    font-size: 10px;
    color: #00ff00;
    text-shadow: 0 0 4px black;
    pointer-events: none;
  }

  .bullet {
    position: absolute;
    width: 4px;
    height: 10px;
    background: currentColor;
    border-radius: 2px;
    box-shadow: 0 0 5px currentColor;
    pointer-events: none;
  }

  #hud {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0,0,0,0.8);
    padding: 15px;
    border-radius: 10px;
    color: white;
    font-size: 14px;
    z-index: 100;
    min-width: 200px;
  }

  #hud h4 {
    color: #00ffff;
    margin-bottom: 10px;
  }

  #connectionStatus {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(0,0,0,0.8);
    padding: 10px 15px;
    border-radius: 5px;
    color: #00ff00;
    font-size: 12px;
    z-index: 100;
  }

  .disconnected {
    color: #ff4444 !important;
  }

  .stat-line {
    margin: 5px 0;
  }

  .best-captain {
    color: #ffd700;
    font-weight: bold;
  }
</style>
</head>

<body>

<div id="gameContainer">
  <video id="background" autoplay muted loop playsinline>
    <source src="universe_loop.mp4" type="video/mp4">
  </video>

  <div id="game"></div>
</div>

<div id="joinPanel">
  <h3>ðŸš€ Join Game</h3>
  
  <label>Your Name</label>
  <input id="playerName" type="text" placeholder="Enter your name" maxlength="20">
  
  <label>Choose Color</label>
  <input id="playerColor" type="color" value="#00ffff">
  
  <button id="joinButton">Join Game</button>
  <button id="adminBtn">Admin Panel</button>
  
  <div id="errorMsg"></div>
  
  <p style="font-size: 11px; margin-top: 15px; color: #888; text-align: center;">
    W=thrust â€¢ A/D=rotate â€¢ SPACE=shoot
  </p>
</div>

<div id="connectionStatus">Connecting...</div>

<div id="hud" style="display: none;">
  <h4>Your Stats</h4>
  <div class="stat-line">Kills: <span id="killCount">0</span></div>
  <div class="stat-line">Health: <span id="healthCount">6</span>/6</div>
  <div class="stat-line">Ship: <span id="shipType">Small</span></div>
  <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
    <div class="stat-line" style="color: #888;">Players: <span id="playerCount">0</span></div>
    <div class="stat-line best-captain">Best Captain: <span id="bestCaptain">-</span></div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const SERVER_URL = window.location.origin;
  const socket = io(SERVER_URL);

  const gameContainer = document.getElementById('gameContainer');
  const game = document.getElementById('game');
  const joinPanel = document.getElementById('joinPanel');
  const hud = document.getElementById('hud');
  const errorMsg = document.getElementById('errorMsg');
  const connectionStatus = document.getElementById('connectionStatus');

  // Fixed game dimensions
  const GAME_WIDTH = 2560;
  const GAME_HEIGHT = 1440;
  const CENTER_X = GAME_WIDTH / 2;
  const CENTER_Y = GAME_HEIGHT / 2;
  const ROTATION_SPEED = 1.8; // Slower for precise aiming

  let myPlayer = null;
  let myPlayerId = null;
  let playerName = '';
  let playerColor = '#00ffff';
  let myX = 0, myY = 0, myAngle = 0, mySpeed = 0;
  let myHealth = 6, myKills = 0, myShipSize = 'small';

  const otherPlayers = new Map();
  const bullets = new Map();
  let lastShot = 0;
  const SHOT_COOLDOWN = 400;
  const MULTI_SHOT_DELAY = 130;
  const keys = {};

  // Scale game to fit window
  function scaleGame() {
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    
    const scaleX = windowWidth / GAME_WIDTH;
    const scaleY = windowHeight / GAME_HEIGHT;
    const scale = Math.min(scaleX, scaleY);
    
    game.style.transform = `scale(${scale})`;
    
    // Center the game
    const scaledWidth = GAME_WIDTH * scale;
    const scaledHeight = GAME_HEIGHT * scale;
    game.style.left = `${(windowWidth - scaledWidth) / 2 / scale}px`;
    game.style.top = `${(windowHeight - scaledHeight) / 2 / scale}px`;
  }

  window.addEventListener('resize', scaleGame);
  scaleGame();

  // Socket events
  socket.on('connect', () => {
    connectionStatus.textContent = 'Connected';
    connectionStatus.classList.remove('disconnected');
  });

  socket.on('disconnect', () => {
    connectionStatus.textContent = 'Disconnected';
    connectionStatus.classList.add('disconnected');
  });

  socket.on('joinSuccess', (data) => {
    myPlayerId = data.playerId;
    joinPanel.style.display = 'none';
    hud.style.display = 'block';
    
    spawnMyPlayer();
    
    data.players.forEach(p => {
      if (p.id !== myPlayerId) {
        addOtherPlayer(p);
      }
    });
    
    updatePlayerCount();
    updateBestCaptain();
  });

  socket.on('joinError', (msg) => {
    errorMsg.textContent = msg;
  });

  socket.on('playerJoined', (player) => {
    addOtherPlayer(player);
    updatePlayerCount();
  });

  socket.on('playerLeft', (playerId) => {
    const player = otherPlayers.get(playerId);
    if (player && player.element) {
      player.element.remove();
    }
    otherPlayers.delete(playerId);
    updatePlayerCount();
    updateBestCaptain();
  });

  socket.on('playerMoved', (data) => {
    const player = otherPlayers.get(data.id);
    if (!player) return;
    
    player.x = data.x;
    player.y = data.y;
    player.angle = data.angle;
    player.speed = data.speed;
  });

  socket.on('bulletFired', (bullet) => {
    if (bullet.owner === myPlayerId) return;
    
    const bulletEl = document.createElement('div');
    bulletEl.className = 'bullet';
    bulletEl.style.color = bullet.color;
    game.appendChild(bulletEl);
    
    bullets.set(bullet.id, {
      ...bullet,
      element: bulletEl
    });
  });

  socket.on('playerDamaged', (data) => {
    if (data.victimId === myPlayerId) {
      myHealth = data.health;
      document.getElementById('healthCount').textContent = myHealth;
      
      if (myPlayer) {
        myPlayer.style.filter = 'brightness(3) saturate(0)';
        setTimeout(() => {
          if (myPlayer) myPlayer.style.filter = '';
        }, 200);
      }
    } else {
      const player = otherPlayers.get(data.victimId);
      if (player && player.element) {
        player.element.style.filter = 'brightness(3) saturate(0)';
        setTimeout(() => {
          if (player.element) player.element.style.filter = '';
        }, 200);
      }
    }
  });

  socket.on('playerDied', (data) => {
    console.log('Player died event:', data); // Debug log
    
    if (data.victimId === myPlayerId) {
      // I died
      die();
    } else if (data.killerId === myPlayerId) {
      // I got a kill
      myKills = data.killerKills;
      myShipSize = data.killerShipSize;
      document.getElementById('killCount').textContent = myKills;
      document.getElementById('shipType').textContent = 
        myShipSize.charAt(0).toUpperCase() + myShipSize.slice(1);
      updateMyShipVisual();
    }
    
    // ALWAYS update other players (regardless of who killed who)
    const victim = otherPlayers.get(data.victimId);
    if (victim) {
      console.log('Removing victim ship:', victim.name); // Debug log
      // Remove the ship element immediately
      if (victim.element) {
        victim.element.remove();
        victim.element = null;
      }
      victim.kills = 0;
      victim.shipSize = 'small';
    }
    
    const killer = otherPlayers.get(data.killerId);
    if (killer) {
      killer.kills = data.killerKills;
      killer.shipSize = data.killerShipSize;
      // Update killer's visual if they have an element
      if (killer.element) {
        killer.element.className = `ship ship-${killer.shipSize}`;
        const nameEl = killer.element.querySelector('.player-name');
        const killsEl = killer.element.querySelector('.kill-counter');
        killer.element.innerHTML = getShipSVG(killer.shipSize);
        if (nameEl) killer.element.appendChild(nameEl);
        if (killsEl) {
          killsEl.textContent = `Kills: ${killer.kills}`;
          killer.element.appendChild(killsEl);
        }
      }
    }
    
    updateBestCaptain();
  });

  socket.on('playerRespawned', (data) => {
    const player = otherPlayers.get(data.id);
    if (!player) return;
    
    // Recreate the ship element if it doesn't exist
    if (!player.element) {
      const el = document.createElement('div');
      el.className = 'ship ship-small';
      el.style.color = player.color;

      const nameEl = document.createElement('div');
      nameEl.className = 'player-name';
      nameEl.textContent = player.name;

      const killsEl = document.createElement('div');
      killsEl.className = 'kill-counter';
      killsEl.textContent = 'Kills: 0';

      el.innerHTML = getShipSVG('small');
      el.appendChild(nameEl);
      el.appendChild(killsEl);

      game.appendChild(el);
      player.element = el;
    }
    
    player.x = data.x;
    player.y = data.y;
    player.angle = 0;
    player.speed = 0;
    player.kills = 0;
    player.shipSize = 'small';
  });

  socket.on('kicked', (msg) => {
    alert(msg);
    window.location.reload();
  });

  socket.on('banned', (msg) => {
    alert(msg);
    window.location.reload();
  });

  // Keyboard
  document.addEventListener('keydown', e => {
    // Only handle game controls if player is active
    if (!myPlayer) return;
    
    keys[e.key.toLowerCase()] = true;
    
    if (e.code === 'Space') { 
      shoot(); 
      e.preventDefault(); 
    }
    
    if (['w','a','d','arrowup','arrowleft','arrowright'].includes(e.key.toLowerCase())) {
      e.preventDefault();
    }
  });

  document.addEventListener('keyup', e => {
    keys[e.key.toLowerCase()] = false;
  });

  function getShipSVG(size) {
    if (size === 'small') {
      return `<svg viewBox="0 0 40 40"><g fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="20,4 28,30 20,24 12,30" />
        <circle cx="20" cy="16" r="2" fill="currentColor" /></g></svg>`;
    } else if (size === 'medium') {
      return `<svg viewBox="0 0 50 50"><g fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="25,4 32,18 42,22 32,26 25,40 18,26 8,22 18,18" />
        <circle cx="25" cy="20" r="3" fill="currentColor" />
        <line x1="22" y1="34" x2="22" y2="42" /><line x1="28" y1="34" x2="28" y2="42" /></g></svg>`;
    } else {
      return `<svg viewBox="0 0 70 70"><g fill="none" stroke="currentColor" stroke-width="2.5">
        <polygon points="35,5 45,20 60,28 45,32 35,55 25,32 10,28 25,20" />
        <polygon points="5,30 15,35 5,40" /><polygon points="65,30 55,35 65,40" />
        <circle cx="35" cy="24" r="4" fill="currentColor" />
        <line x1="30" y1="52" x2="30" y2="65" /><line x1="35" y1="52" x2="35" y2="65" />
        <line x1="40" y1="52" x2="40" y2="65" /></g></svg>`;
    }
  }

  function spawnMyPlayer() {
    myPlayer = document.createElement('div');
    myPlayer.className = 'ship ship-small';
    myPlayer.style.color = playerColor;

    const nameEl = document.createElement('div');
    nameEl.className = 'player-name';
    nameEl.textContent = playerName + ' (You)';

    const killsEl = document.createElement('div');
    killsEl.className = 'kill-counter';
    killsEl.textContent = 'Kills: 0';

    myPlayer.innerHTML = getShipSVG('small');
    myPlayer.appendChild(nameEl);
    myPlayer.appendChild(killsEl);

    // Random spawn position
    const angle = Math.random() * Math.PI * 2;
    const distance = 400 + Math.random() * 200;
    myX = CENTER_X + Math.cos(angle) * distance;
    myY = CENTER_Y + Math.sin(angle) * distance;
    myAngle = 0;

    game.appendChild(myPlayer);
  }

  function addOtherPlayer(player) {
    const el = document.createElement('div');
    el.className = `ship ship-${player.shipSize}`;
    el.style.color = player.color;

    const nameEl = document.createElement('div');
    nameEl.className = 'player-name';
    nameEl.textContent = player.name;

    const killsEl = document.createElement('div');
    killsEl.className = 'kill-counter';
    killsEl.textContent = `Kills: ${player.kills}`;

    el.innerHTML = getShipSVG(player.shipSize);
    el.appendChild(nameEl);
    el.appendChild(killsEl);

    game.appendChild(el);

    otherPlayers.set(player.id, {
      ...player,
      element: el
    });
  }

  function updateMyShipVisual() {
    if (!myPlayer) return;

    myPlayer.className = `ship ship-${myShipSize}`;
    const nameEl = myPlayer.querySelector('.player-name');
    const killsEl = myPlayer.querySelector('.kill-counter');
    myPlayer.innerHTML = getShipSVG(myShipSize);
    myPlayer.appendChild(nameEl);
    myPlayer.appendChild(killsEl);
    if (killsEl) killsEl.textContent = `Kills: ${myKills}`;
  }

  function shoot() {
    const now = Date.now();
    if (now - lastShot < SHOT_COOLDOWN) return;
    lastShot = now;

    const radians = myAngle * Math.PI / 180;
    
    // Determine number of shots based on ship size
    let numShots = 1;
    if (myShipSize === 'medium') numShots = 2;
    if (myShipSize === 'large') numShots = 3;

    // Fire shots in STRAIGHT LINE with 130ms delay between each
    for (let i = 0; i < numShots; i++) {
      setTimeout(() => {
        fireSingleBullet(radians);
      }, i * MULTI_SHOT_DELAY);
    }
  }

  function fireSingleBullet(radians) {
    // Spawn from center front of ship (NO offset, NO spread)
    const bulletX = myX + Math.sin(radians) * 25;
    const bulletY = myY - Math.cos(radians) * 25;
    const vx = Math.sin(radians) * 8;
    const vy = -Math.cos(radians) * 8;

    socket.emit('shoot', { x: bulletX, y: bulletY, vx, vy });

    const bulletEl = document.createElement('div');
    bulletEl.className = 'bullet';
    bulletEl.style.color = playerColor;
    game.appendChild(bulletEl);

    const bulletId = `${myPlayerId}_${Date.now()}_${Math.random()}`;
    bullets.set(bulletId, {
      id: bulletId,
      x: bulletX,
      y: bulletY,
      vx, vy,
      color: playerColor,
      owner: myPlayerId,
      element: bulletEl
    });
  }

  function updateBullets() {
    bullets.forEach((bullet, id) => {
      bullet.x += bullet.vx;
      bullet.y += bullet.vy;

      // Remove if off screen
      if (bullet.x < -100 || bullet.x > GAME_WIDTH + 100 ||
          bullet.y < -100 || bullet.y > GAME_HEIGHT + 100) {
        bullet.element.remove();
        bullets.delete(id);
        return;
      }

      // Check collision with my player
      if (bullet.owner !== myPlayerId && myPlayer) {
        const dist = Math.sqrt((bullet.x - myX)**2 + (bullet.y - myY)**2);
        if (dist < 25) {
          socket.emit('playerHit', { victimId: myPlayerId, shooterId: bullet.owner });
          bullet.element.remove();
          bullets.delete(id);
          return;
        }
      }

      // Check collision with other players
      if (bullet.owner === myPlayerId) {
        for (const [pid, player] of otherPlayers.entries()) {
          const dist = Math.sqrt((bullet.x - player.x)**2 + (bullet.y - player.y)**2);
          if (dist < 25) {
            socket.emit('playerHit', { victimId: pid, shooterId: myPlayerId });
            bullet.element.remove();
            bullets.delete(id);
            return;
          }
        }
      }

      bullet.element.style.transform = `translate(${bullet.x}px, ${bullet.y}px)`;
    });
  }

  function die() {
    if (myPlayer) {
      myPlayer.remove();
      myPlayer = null;
    }
    
    myHealth = 6;
    myKills = 0;
    myShipSize = 'small';

    setTimeout(() => respawn(), 3000);
  }

  function respawn() {
    spawnMyPlayer();

    // Random respawn
    const angle = Math.random() * Math.PI * 2;
    const distance = 400 + Math.random() * 200;
    myX = CENTER_X + Math.cos(angle) * distance;
    myY = CENTER_Y + Math.sin(angle) * distance;
    myAngle = 0;
    mySpeed = 0;

    socket.emit('respawn', { x: myX, y: myY });

    document.getElementById('healthCount').textContent = myHealth;
    document.getElementById('killCount').textContent = myKills;
    document.getElementById('shipType').textContent = 'Small';
  }

  function updatePlayerCount() {
    document.getElementById('playerCount').textContent = otherPlayers.size + 1;
  }

  function updateBestCaptain() {
    let bestName = playerName;
    let bestKills = myKills;

    otherPlayers.forEach(player => {
      if (player.kills > bestKills) {
        bestKills = player.kills;
        bestName = player.name;
      }
    });

    document.getElementById('bestCaptain').textContent = bestKills > 0 ? bestName : '-';
  }

  function joinGame() {
    const name = document.getElementById('playerName').value.trim();
    if (!name) {
      errorMsg.textContent = 'Please enter a name';
      return;
    }

    playerName = name;
    playerColor = document.getElementById('playerColor').value;

    socket.emit('join', { name, color: playerColor });
  }

  document.getElementById('joinButton').addEventListener('click', joinGame);
  document.getElementById('playerName').addEventListener('keypress', e => {
    if (e.key === 'Enter') joinGame();
  });

  document.getElementById('adminBtn').addEventListener('click', () => {
    const password = prompt('Enter admin password:');
    if (password === '3310') {
      window.location.href = '/admin.html';
    } else if (password) {
      alert('Incorrect password');
    }
  });

  function update() {
    if (myPlayer) {
      // Slower rotation
      if (keys['a'] || keys['arrowleft']) myAngle -= ROTATION_SPEED;
      if (keys['d'] || keys['arrowright']) myAngle += ROTATION_SPEED;

      // Thrust
      if (keys['w'] || keys['arrowup']) mySpeed = Math.min(mySpeed + 0.3, 5);
      else mySpeed *= 0.96;

      // Movement
      const radians = myAngle * Math.PI / 180;
      myX += Math.sin(radians) * mySpeed;
      myY -= Math.cos(radians) * mySpeed;

      // Screen wrapping
      if (myX < 0) myX = GAME_WIDTH;
      if (myX > GAME_WIDTH) myX = 0;
      if (myY < 0) myY = GAME_HEIGHT;
      if (myY > GAME_HEIGHT) myY = 0;

      myPlayer.style.transform = `translate(${myX}px, ${myY}px) rotate(${myAngle}deg)`;

      // Send to server more frequently to reduce lag
      if (Math.random() < 0.5) { // Increased from 0.1 to 0.5 for smoother sync
        socket.emit('updatePlayer', {
          x: myX,
          y: myY,
          angle: myAngle,
          speed: mySpeed
        });
      }
    }

    // Update other players
    otherPlayers.forEach(player => {
      if (player.element) {
        player.element.style.transform = 
          `translate(${player.x}px, ${player.y}px) rotate(${player.angle}deg)`;
      }
    });

    updateBullets();
    requestAnimationFrame(update);
  }

  update();
</script>

</body>
</html>
